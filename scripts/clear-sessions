#!/bin/bash

# Clear Sessions - Based on .env configuration

# Load .env file
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
else
    echo "âŒ .env file not found"
    exit 1
fi

echo "ðŸ” Detected SESSION_DRIVER: ${SESSION_DRIVER:-file}"

case "$SESSION_DRIVER" in
    file)
        echo "ðŸ—‘ï¸  Clearing file-based sessions..."
        rm -rf storage/framework/sessions/*
        echo "âœ… File sessions cleared"
        ;;

    database)
        echo "ðŸ—‘ï¸  Clearing database sessions..."
        php artisan tinker --execute="DB::table('sessions')->truncate(); echo 'âœ… Database sessions cleared';"
        ;;

    redis)
        echo "ðŸ—‘ï¸  Clearing Redis sessions..."
        php artisan cache:clear
        echo "âœ… Redis sessions cleared via cache:clear"
        ;;

    memcached|dynamodb|array)
        echo "ðŸ—‘ï¸  Clearing cache-based sessions..."
        php artisan cache:clear
        echo "âœ… Cache sessions cleared"
        ;;

    cookie)
        echo "âš ï¸  Cookie sessions are stored client-side"
        echo "ðŸ’¡ Users need to clear browser cookies manually"
        ;;

    *)
        echo "âš ï¸  Unknown session driver: $SESSION_DRIVER"
        echo "ðŸ—‘ï¸  Attempting generic cache clear..."
        php artisan cache:clear
        rm -rf storage/framework/sessions/* 2>/dev/null
        echo "âœ… Cache and file sessions cleared"
        ;;
esac

echo ""
echo "ðŸ§¹ Also clearing auth cache..."
php artisan cache:clear
php artisan auth:clear-resets 2>/dev/null || true

echo ""
echo "âœ… Sessions cleared! Users must re-login."
